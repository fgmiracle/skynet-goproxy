package main

import (
    // "encoding/binary"
    "fmt"
    // "reflect"
    // "bytes"
    "net"
    "skynetproxy"
)

const svrName          string = "golangsvr"
const svrID            uint8 = 1

// 更新赛事信息的结构
type competition_data struct {
    Champion_times      int `champion_times`
    Second_times        int `second_times`
    Third_times         *int `third_times`
    Competition_times   int `competition_times`
}

func main() {
    // ms := struct {
    //     Champion_times      int `champion_times`
    //     Second_times        int `second_times`
    // } {
    //     10,
    //     10,
    // }

    
    conn, err := net.Dial("tcp", "localhost:8586")
    if err != nil {
        fmt.Println("Error dialing", err.Error())
    }

    ret, recvBytes := skynetproxy.PackMsg("REGISTER",svrName,svrID)
    if ret {

        conn.Write(skynetproxy.PackProxyMsg(recvBytes))

        //var readbuf []byte
        readbuf := make([]byte, 512) 
        //收到注册成功消息
        len, err := conn.Read(readbuf)
        if err != nil {
            fmt.Printf("recv error! packLen:%d \n",len)
        } else {
            //解析包头
            datasize := skynetproxy.DataSize(readbuf)
            fmt.Printf("recv data! packLen:%d , dataLen:%d \n",len, datasize)
            fmt.Println(skynetproxy.UnPackMsg(skynetproxy.UnPackProxyMsg(readbuf[:len])))
        }
    }

    // 测试 发送一些测试消息
    dest := (11 << 16 | 1)
    // send
    //ret, recvBytes = skynetproxy.PackMsg("RELAY", dest, "TO", false ,".msg_handler","update_competition_data",693, ms)
    // call
    ret, recvBytes = skynetproxy.PackMsg("RELAY", dest, "TO", 1 ,".msg_handler","get_base_data",693)
    //buf := makePackHeader(recvBytes)
    conn.Write(skynetproxy.PackProxyMsg(recvBytes))
    if true {
        readbuf := make([]byte, 2048) 
        len, err := conn.Read(readbuf)
        fmt.Println(readbuf)
        if err != nil {
            fmt.Printf("recv error! packLen:%d \n",len)
        } else {
            //解析包头
            datasize := skynetproxy.DataSize(readbuf)
            fmt.Printf("recv data! packLen:%d , dataLen:%d \n",len, datasize)
            dataPorxy := skynetproxy.UnPackProxyMsg(readbuf[:len])
            fmt.Println(dataPorxy)
            fmt.Println(skynetproxy.UnPackMsg(dataPorxy))
        }
    }
    
    /*
    testTb := []byte{
        44,82,69,76,65,89,34,1,0,11,0,36,66,65,67,75,10,
        1,6,164,116,111,100,97,121,95,101,120,99,104,97,
        110,103,101,95,99,111,105,110,115,2,76,103,117,
        110,115,95,108,105,115,116,14,10,1,0,124,102,114,101,101,
        95,116,105,109,101,115,95,100,97,116,97,6,0,84,114,101,100,95,
        112,97,99,107,101,116,10,4,164,108,97,115,116,95,116,111,95,115,
        101,99,111,110,100,115,95,116,105,109,101,34,221,239,33,92,164,
        116,111,116,97,108,95,99,104,97,109,112,105,111,110,95,116,105,
        109,101,115,10,10,148,99,97,114,100,95,110,111,116,101,95,101,
        110,100,95,116,105,109,101,2,76,97,102,102,101,99,116,95,105,
        100,2,148,108,97,115,116,95,116,119,95,99,111,105,110,115,95,116,
        105,109,101,34,221,239,33,92,44,99,111,105,110,115,2,44,116,105,
        116,108,101,4,100,106,105,97,98,101,105,95,99,97,114,100,115,2,84,
        119,101,101,107,95,97,119,97,114,100,6,76,100,97,121,95,99,111,117,
        110,116,10,1,92,116,111,116,97,108,95,97,119,97,114,100,2,124,108,
        97,115,116,95,99,104,101,99,107,95,116,105,109,101,2,148,99,97,110,
        95,101,120,99,104,97,110,103,101,95,97,119,97,114,100,2,140,116,111,
        100,97,121,95,99,111,105,110,115,95,119,97,116,101,114,2,84,108,97,
        115,116,95,97,119,97,114,100,2,0,124,114,97,116,101,95,111,102,95,119,
        105,110,110,105,110,103,6,0,100,97,102,102,101,99,116,95,99,111,117,
        110,116,2,84,112,108,97,121,95,99,111,117,110,116,2,148,99,111,109,
        112,101,110,115,97,116,105,111,110,95,116,105,109,101,115,2,100,99,
        114,101,97,116,101,100,95,116,105,109,101,34,221,239,33,92,68,115,97,
        102,101,95,98,111,120,2,148,116,111,116,97,108,95,115,101,99,111,110,100,
        95,116,105,109,101,115,10,10,156,99,117,114,114,95,99,111,110,116,114,111,
        108,95,115,116,97,116,117,115,2,68,98,105,110,100,95,117,105,100,2,100,99,
        111,105,110,115,95,108,111,99,107,101,100,2,164,108,97,115,116,95,108,97,115,
        101,95,99,111,105,110,115,95,116,105,109,101,2,172,108,97,115,116,95,
        108,111,103,105,110,95,101,109,112,116,121,95,116,105,109,101,34,142,17,
        101,92,124,99,97,114,100,95,110,111,116,101,95,99,111,117,110,116,10,1,
        140,99,111,109,112,101,116,105,116,105,111,110,95,116,105,109,101,115,2,76,
        112,97,121,95,109,111,110,101,121,2,92,116,104,105,114,100,95,116,105,109,
        101,115,2,140,116,111,116,97,108,95,116,104,105,114,100,95,116,105,109,101,
        115,2,100,97,102,102,101,99,116,95,115,116,97,116,101,2,76,118,105,112,95,108,
        101,118,101,108,2,36,103,101,109,115,2,92,97,119,97,114,100,95,116,105,109,101,
        115,10,20,76,112,108,97,121,95,116,105,109,101,2,164,114,101,100,95,101,120,99,
        104,97,110,103,101,95,116,105,99,107,101,116,115,2,100,99,111,110,116,114,105,
        98,117,116,105,111,110,6,0,44,109,111,110,101,121,2,60,99,114,101,100,105,116,
        115,18,162,8,84,99,117,114,114,95,112,111,119,101,114,10,1,148,105,110,105,116,
        95,99,111,110,116,114,111,108,95,99,111,105,110,115,2,124,116,111,100,97,121,95,
        119,105,110,95,99,111,105,110,115,2,68,109,97,120,95,103,101,109,115,2,156,99,117,
        114,114,95,99,111,110,116,114,111,108,95,119,101,105,103,104,116,2,92,97,102,102,101,
        99,116,95,114,97,116,101,2,60,104,105,116,114,97,116,101,10,1,204,108,97,115,116,95,
        99,97,105,115,104,101,110,95,116,114,105,103,103,101,114,95,116,105,109,101,2,92,112,101,
        114,115,111,110,95,114,97,116,101,10,1,76,105,116,101,109,95,108,105,115,116,6,0,28,117,
        105,100,18,181,2,132,101,120,99,104,97,110,103,101,95,116,105,99,107,101,116,115,2,84,116,
        105,116,108,101,95,116,105,109,101,2,100,115,101,99,111,110,100,95,116,105,109,101,115,2,
        148,108,97,115,116,95,116,101,95,99,111,105,110,115,95,116,105,109,101,34,221,239,33,92,124,
        99,108,117,98,95,112,108,97,121,95,116,105,109,101,115,2,156,108,97,115,116,95,99,114,111,115,
        115,95,100,97,121,95,116,105,109,101,2,148,99,117,114,114,95,99,111,110,116,114,111,108,95,99,
        111,105,110,115,2,108,119,105,110,108,111,115,101,95,99,111,105,110,115,2,76,99,117,114,114,95,
        103,117,110,115,10,1,68,106,97,99,107,112,111,116,115,6,0,100,99,104,97,114,103,101,95,99,111,
        117,110,116,2,76,114,111,111,109,99,97,114,100,115,2,164,116,111,100,97,121,95,111,110,108,105,
        110,101,95,115,101,99,111,110,100,115,2,116,99,104,97,109,112,105,111,110,95,116,105,109,101,115,
        10,7,132,116,111,116,97,108,95,102,114,101,101,95,116,105,109,101,115,2,84,108,111,115,101,95,99,111,105,110,115,2,0,
    }
    

    
    testTb := []byte{
        6,164,116,111,100,97,121,95,101,120,99,104,97,110,103,101,95,99,111,105,110,115,2,76,103,117,110,115,95,108,105,115,116,14,10,1,0,124,102,114,101,101,95,116,105,109,101,115,95,100,97,116,97,6,0,84,114,101,100,95,112,97,99,107,101,116,10,4,164,108,97,115,116,95,116,111,95,115,101,99,111,110,100,115,95,116,105,109,101,34,221,239,33,92,164,116,111,116,97,108,95,99,104,97,109,112,105,111,110,95,116,105,109,101,115,10,10,148,99,97,114,100,95,110,111,116,101,95,101,110,100,95,116,105,109,101,2,76,97,102,102,101,99,116,95,105,100,2,148,108,97,115,116,95,116,119,95,99,111,105,110,115,95,116,105,109,101,34,221,239,33,92,44,99,111,105,110,115,2,44,116,105,116,108,101,4,100,106,105,97,98,101,105,95,99,97,114,100,115,2,84,119,101,101,107,95,97,119,97,114,100,6,76,100,97,121,95,99,111,117,110,116,10,1,92,116,111,116,97,108,95,97,119,97,114,100,2,124,108,97,115,116,95,99,104,101,99,107,95,116,105,109,101,2,148,99,97,110,95,101,120,99,104,97,110,103,101,95,97,119,97,114,100,2,140,116,111,100,97,121,95,99,111,105,110,115,95,119,97,116,101,114,2,84,108,97,115,116,95,97,119,97,114,100,2,0,124,114,97,116,101,95,111,102,95,119,105,110,110,105,110,103,6,0,100,97,102,102,101,99,116,95,99,111,117,110,116,2,84,112,108,97,121,95,99,111,117,110,116,2,148,99,111,109,112,101,110,115,97,116,105,111,110,95,116,105,109,101,115,2,100,99,114,101,97,116,101,100,95,116,105,109,101,34,221,239,33,92,68,115,97,102,101,95,98,111,120,2,148,116,111,116,97,108,95,115,101,99,111,110,100,95,116,105,109,101,115,10,10,156,99,117,114,114,95,99,111,110,116,114,111,108,95,115,116,97,116,117,115,2,68,98,105,110,100,95,117,105,100,2,100,99,111,105,110,115,95,108,111,99,107,101,100,2,164,108,97,115,116,95,108,97,115,101,95,99,111,105,110,115,95,116,105,109,101,2,172,108,97,115,116,95,108,111,103,105,110,95,101,109,112,116,121,95,116,105,109,101,34,142,17,101,92,124,99,97,114,100,95,110,111,116,101,95,99,111,117,110,116,10,1,140,99,111,109,112,101,116,105,116,105,111,110,95,116,105,109,101,115,2,76,112,97,121,95,109,111,110,101,121,2,92,116,104,105,114,100,95,116,105,109,101,115,2,140,116,111,116,97,108,95,116,104,105,114,100,95,116,105,109,101,115,2,100,97,102,102,101,99,116,95,115,116,97,116,101,2,76,118,105,112,95,108,101,118,101,108,2,36,103,101,109,115,2,92,97,119,97,114,100,95,116,105,109,101,115,10,20,76,112,108,97,121,95,116,105,109,101,2,164,114,101,100,95,101,120,99,104,97,110,103,101,95,116,105,99,107,101,116,115,2,100,99,111,110,116,114,105,98,117,116,105,111,110,6,0,44,109,111,110,101,121,2,60,99,114,101,100,105,116,115,18,162,8,84,99,117,114,114,95,112,111,119,101,114,10,1,148,105,110,105,116,95,99,111,110,116,114,111,108,95,99,111,105,110,115,2,124,116,111,100,97,121,95,119,105,110,95,99,111,105,110,115,2,68,109,97,120,95,103,101,109,115,2,156,99,117,114,114,95,99,111,110,116,114,111,108,95,119,101,105,103,104,116,2,92,97,102,102,101,99,116,95,114,97,116,101,2,60,104,105,116,114,97,116,101,10,1,204,108,97,115,116,95,99,97,105,115,104,101,110,95,116,114,105,103,103,101,114,95,116,105,109,101,2,92,112,101,114,115,111,110,95,114,97,116,101,10,1,76,105,116,101,109,95,108,105,115,116,6,0,28,117,105,100,18,181,2,132,101,120,99,104,97,110,103,101,95,116,105,99,107,101,116,115,2,84,116,105,116,108,101,95,116,105,109,101,2,100,115,101,99,111,110,100,95,116,105,109,101,115,2,148,108,97,115,116,95,116,101,95,99,111,105,110,115,95,116,105,109,101,34,221,239,33,92,124,99,108,117,98,95,112,108,97,121,95,116,105,109,101,115,2,156,108,97,115,116,95,99,114,111,115,115,95,100,97,121,95,116,105,109,101,2,148,99,117,114,114,95,99,111,110,116,114,111,108,95,99,111,105,110,115,2,108,119,105,110,108,111,115,101,95,99,111,105,110,115,2,76,99,117,114,114,95,103,117,110,115,10,1,68,106,97,99,107,112,111,116,115,6,0,100,99,104,97,114,103,101,95,99,111,117,110,116,2,76,114,111,111,109,99,97,114,100,115,2,164,116,111,100,97,121,95,111,110,108,105,110,101,95,115,101,99,111,110,100,115,2,116,99,104,97,109,112,105,111,110,95,116,105,109,101,115,10,7,132,116,111,116,97,108,95,102,114,101,101,95,116,105,109,101,115,2,84,108,111,115,101,95,99,111,105,110,115,2,0,
    }

    fmt.Println(skynetproxy.UnPackMsg(testTb))

    */
}
